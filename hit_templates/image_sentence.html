<html>

<head>
    <title>Select the most similar icon</title>
    <!-- simpleamt depends on these libraries -->
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>
    <!-- end of required libraries -->
    <script src='//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #text-area {
            margin: 10px 0;
            font-size: 24pt;
        }

        div.instructions {
            border: 1px solid #000;
            padding: 15px;
            margin: auto;
            background-color: #eee;
            width: 800px;
            align-content: center;
        }

        #button-div {
            margin-bottom: 10px;
        }

        #counter {
            margin: 0 10px;
            font-size: 20pt;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class='container'>
        <h1>Some title...</h1>
    </div>
    <div class='container-fluid'>
        <div class="col-md-12">
            <div class="instructions" style="overflow: hidden;margin-bottom:25px ">
                <h2>Icon Selection Survey</h2> First of all, thank you for spending your time participating in our user study. It should not take longer than <u>10 minutes</u> to complete. Please, read carefully the instructions before you proceed with the survey.

                <h3>How to do the task</h3> In order to accomplish the following task successfully you will have to imagine that you are designing a graphical user interface where you need to place a group of icons. You already have placed the reference icon and you need to place
                another one whose style is visually similar to the style of the reference. Your task now is to select the image A or B regarding which one matches better with the reference. In some cases, neither A nor B will seem visually similar to
                the Reference, in this scenario try to make the best choice you can.

                <h3>Selection example</h3> Before you begin the survey we will show you two basic examples of an icon selection task with the answers explained.

                <p>- In <b>Example 1</b> the correct option will be A. The icon A has no contour lines, and it is a solid icon filled in dark colour, exactly as the reference. The icon B is not filled in and it has a medium-thick contour line, not matching
                    in style with the reference. The icon B and the Reference have the same arrow shape, but we are focusing on style consequently it will not affect the decision.</p>

                <p>- In <b>Example 2</b>, the correct option will be A. The icon A has a thin contour line and it is not filled in, sharing these style properties with the Reference. The icon B is not filled in but its contour lines are really thick which
                    is the opposite as the Reference's contour lines.</p>

                <h3>That's all folks</h3> Please note that javascript should be enabled for the survey to work correctly.<br> In case you have any comments or questions, please write an email to <a href="mailto:504185@unizar.es">504185@unizar.es</a><br><br> Press <i>Start</i>                to begin the survey.

                <div id="initialExamples" class="row text-center" style="margin-top:30px;">
                    <div class='col-xs-12 text-center'>
                        <div class='col-xs-push-1 col-xs-3 text-center'>
                            <img id="example1" style="width:300px; border: 1px solid #000; background-color:white;" src="https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/ex1.png">
                        </div>
                        <div class='col-xs-push-3 col-xs-3 text-center'>

                            <img id="example2" style="width:300px; border: 1px solid #000; background-color:white;" src="https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/ex2.png">
                        </div>
                    </div>
                </div>
                <div class='row text-center' style="margin-top:60px;" id='train-btn-div'>
                    <button type="button" class='btn btn-lg btn-primary' id="btn_examples" style="margin-top:100px; margin:auto;">START</button>
                </div>
            </div>
        </div>
    </div>
    <div id="triplet_show" class='container-fluid' style="display:none;">
        <div class='row' style="margin-top : 25px; margin-bottom:25px; ">
            <div class='col-xs-12 text-center'>
                <div id='text-container1'>
                </div>
                <div id='image-container1'>
                </div>
            </div>
        </div>
        <form id="selectionForm">
            <div class='row' style="margin-bottom : 50px; margin-top : 30px">
                <div class='col-xs-12 text-center'>
                    <div class='col-xs-push-4 col-xs-2 text-center'>
                        <div id='text-container2'>
                        </div>
                        <div id='image-container2'>
                        </div>
                        <div id='radio-container2'>
                        </div>
                    </div>
                    <div class='col-xs-push-4 col-xs-2 text-center'>
                        <div id='text-container3'>
                        </div>
                        <div id='image-container3'>
                        </div>
                        <div id='radio-container3'>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class='row'>
            <div class='col-xs-4 col-xs-offset-4 text-center' id='button-div'>
                <button id='prev-btn' class='btn btn-lg btn-primary' disabled>Back</button>
                <span id='counter'>
            <span class='counter-top'></span> / <span class='counter-bottom'></span>
                </span>
                <button id='next-btn' class='btn btn-lg btn-primary' disabled>Next</button>
            </div>
        </div>
        <div class='row'>
            <form id='results-form' method='post' action='dummy' class='text-center'>
                <input type='hidden' value='' name='assignmentId' id='assignmentId' />
                <input type='hidden' value='' name='output' id='output' />
                <input type='submit' class='btn btn-lg btn-success' id='submit-btn' value='Submit' disabled />
            </form>
        </div>
    </div>



    <div id="training" class='container-fluid' style="display:none;">
        <div class='row' style="margin-top : 25px; margin-bottom:25px ;">
            <div class='col-xs-12 text-center'>
                <div id='text-train-container1'>
                </div>
                <div id='image-train-container1'>
                </div>
            </div>
        </div>
        <form id="selectionForm">
            <div class='row' style="margin-bottom : 50px; margin-top : 30px">
                <div class='col-xs-12 text-center'>
                    <div class='col-xs-push-4 col-xs-2 text-center'>
                        <div id='text-train-container2'>
                        </div>
                        <div id='image-train-container2'>
                        </div>
                        <div id='radio-train-container2'>
                        </div>
                    </div>
                    <div class='col-xs-push-4 col-xs-2 text-center'>
                        <div id='text-train-container3'>
                        </div>
                        <div id='image-train-container3'>
                        </div>
                        <div id='radio-train-container3'>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class='row'>
            <div class='col-xs-4 col-xs-offset-4 text-center' id='button-div'>
                <button id='prev-train-btn' class='btn btn-lg btn-primary' disabled>Back</button>
                <span id='counter'>
            <span class='counter-train-top'></span> / <span class='counter-train-bot'></span>
                </span>
                <button id='next-train-btn' class='btn btn-lg btn-primary' disabled>Next</button>
            </div>
        </div>
        <div class='row'>
            <div class='col-xs-4 col-xs-offset-4 text-center' id='button-div-submit' style='margin-bottom:50px;'>
                <button id='submit-train-btn' class='btn btn-lg btn-primary' disabled>Start the test</button>
            </div>
        </div>
    </div>

    {% include "simpleamt.html" %}
    <script>
        $(function() {
            var t0 = 0;
            var t1 = 0;
            // Parallel to input
            var answers = [];
            var TRAIN_CORRECT = ["B", "A", "B", "A"];
            var train_answer = ["", "", "", ""]
            var correct_train = 0;
            var time = [];
            // Define some default input.
            var ID_INPUT = [];
            var rndTrain = Math.floor(Math.random() * 5);
            var TRAIN_INPUT = [
                [
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet11.png",
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet12.png",
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet13.png"
                ],
                [
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet21.png",
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet22.png",
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet23.png"
                ],
                [
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet31.png",
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet32.png",
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet33.png"
                ],
                [
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet41.png",
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet42.png",
                    "https://raw.githubusercontent.com/mlagunas/simple-amt/master/EXAMPLES/training/triplet43.png"
                ]
            ];

            var DEFAULT_INPUT = [
                ["/examples/images/101250.png", "/examples/images/101258.png", "/examples/images/101258.png"],
                ["/examples/images/101258.png", "/examples/images/101250.png", "/examples/images/101250.png"],
                ["/examples/images/101258.png", "/examples/images/101250.png", "/examples/images/101262.png"]
            ]

            var input = null;

            // Some variables to track state of the HIT.
            var idx = 0;
            var idxt = 0
            var enabled = false;

            function main() {
                // If this is a HIT on AMT, then replace the default input with the real input.
                input = simpleamt.getInput(DEFAULT_INPUT);
                console.log("input retrieved")
                    // Enable the UI if the HIT is not in preview mode.
                if (!simpleamt.isPreview()) {
                    enable_hit();
                }
                console.log("hit enabled")

                var index = 0;
                // Set up the descriptions.
                _.each(input, function() {
                    answers.push('');
                    time.push(0);
                    ID_INPUT.push(index);
                    index += 1;
                });
                console.log("initialized tables")

                // Preload all images
                var imgs = [];
                _.each(input, function(img_url) {
                    var img = new Image();
                    img.onload = function() {};
                    img.src = img_url;
                });
                console.log("initialized images")
                render();
                console.log("html rendered")
            }



            // Use the current index to update the image and description
            function render() {
                // Set up the images
                // TRAINING PART
                $('#image-train-container1').empty();
                $('#text-train-container1').empty();
                $('#text-train-container1').append('<h3> Reference </h3>')
                $('<img>').attr('src', TRAIN_INPUT[idxt][0]).attr('style', 'height: 100px; border: 1px solid #000;').appendTo($('#image-train-container1'));

                $('#image-train-container2').empty();
                $('#radio-train-container2').empty();
                $('#text-train-container2').empty();
                $('#text-train-container2').append('<h3> A </h3>')
                $('<img>').attr('src', TRAIN_INPUT[idxt][1]).attr('style', 'height: 100px; border: 1px solid #000;').appendTo($('#image-train-container2'));
                $('<input>').attr('type', 'radio').attr('name', 'radioName').attr('id', 'rbt2').attr('value', 'A').appendTo($('#radio-train-container2'));

                $('#image-train-container3').empty();
                $('#radio-train-container3').empty();
                $('#text-train-container3').empty();
                $('#text-train-container3').append('<h3> B </h3>')
                $('<img>').attr('src', TRAIN_INPUT[idxt][2]).attr('style', 'height: 100px; border: 1px solid #000;').appendTo($('#image-train-container3'));
                $('<input>').attr('type', 'radio').attr('name', 'radioName').attr('id', 'rbt3').attr('value', 'B').appendTo($('#radio-train-container3'));

                //TEST PART
                $('#image-container1').empty();
                $('#text-container1').empty();
                $('#text-container1').append('<h3> Reference </h3>')
                $('<img>').attr('src', input[idx][0]).attr('style', 'height: 100px; border: 1px solid #000;').appendTo($('#image-container1'));

                $('#image-container2').empty();
                $('#radio-container2').empty();
                $('#text-container2').empty();
                $('#text-container2').append('<h3> A </h3>')
                $('<img>').attr('src', input[idx][1]).attr('style', 'height: 100px; border: 1px solid #000;').appendTo($('#image-container2'));
                $('<input>').attr('type', 'radio').attr('name', 'radioName').attr('id', 'rb2').attr('value', 'A').appendTo($('#radio-container2'));

                $('#image-container3').empty();
                $('#radio-container3').empty();
                $('#text-container3').empty();
                $('#text-container3').append('<h3> B </h3>')
                $('<img>').attr('src', input[idx][2]).attr('style', 'height: 100px; border: 1px solid #000;').appendTo($('#image-container3'));
                $('<input>').attr('type', 'radio').attr('name', 'radioName').attr('id', 'rb3').attr('value', 'B').appendTo($('#radio-container3'));

                // Set up the text area
                // $('#text-area').val(descriptions[idx]);

                // Refresh the counter
                $('.counter-top').text(idx + 1);
                $('.counter-bottom').text(input.length);
                $('.counter-train-top').text(idxt + 1);
                $('.counter-train-bot').text(TRAIN_INPUT.length);

                // If the UI is enabled, enable or disable the buttons depending on
                // the index.
                if (enabled) {

                    var prev_btn = $('#prev-btn');
                    var next_btn = $('#next-btn');

                    var prev_btn_train = $('#prev-train-btn');
                    var next_btn_train = $('#next-train-btn');

                    var next = false

                    prev_btn.prop('disabled', true);
                    next_btn.prop('disabled', true);
                    next_btn_train.prop('disabled', true)
                    prev_btn_train.prop('disabled', true)

                    $('#btn_examples').click(function() {
                        $('#training').css("display", "block");
                        $('#train-btn-div').css("display", "none")
                        $('#btn_examples').prop('disabled', true);
                    });

                    if (answers[idx] != null) {
                        if (answers[idx] == 2) {
                            $('#rb2').prop('checked', true)
                        }
                        if (answers[idx] == 3) {
                            $('#rb3').prop('checked', true)
                        }
                    }

                    $('#rb2').on('change', function() {
                        next = true
                        answers[idx] = 2
                        if (idx < input.length - 1) {
                            next_btn.prop('disabled', false);
                        }
                    })

                    $('#rb3').on('change', function() {
                        next = true
                        answers[idx] = 3
                        if (idx < input.length - 1) {
                            next_btn.prop('disabled', false);
                        }
                    })

                    $('#rbt2').on('change', function() {
                        next = true
                        train_answer[idxt] = "A"
                        if (idxt < TRAIN_INPUT.length - 1) {
                            next_btn_train.prop('disabled', false);
                        }
                    })

                    $('#rbt3').on('change', function() {
                        next = true
                        train_answer[idxt] = "B"
                        if (idxt < TRAIN_INPUT.length - 1) {
                            next_btn_train.prop('disabled', false);
                        }
                    })

                    if (idx > 0) {
                        prev_btn.prop('disabled', false);
                    }
                    if (idxt > 0 && idxt < TRAIN_INPUT.length) {
                        prev_btn_train.prop('disabled', false);
                    }

                    if (idx + 1 == input.length) {
                        $('#submit-btn').prop('disabled', false);
                    }

                    if (idxt + 1 == TRAIN_INPUT.length) {
                        $('#submit-train-btn').prop('disabled', false);
                    }
                }
                t0 = new Date().getTime();
            }

            function get_accuracy() {
                var acc = 0;
                for (i = 0; i < train_answer.length; i++) {
                    if (TRAIN_CORRECT[i] == train_answer[i]) {
                        acc++;
                    }
                }
                return acc;
            }

            // Update the index, and save the text in the text area.
            function set_idx(new_idx) {

                if (new_idx < 0 || new_idx >= input.length) return;
                // descriptions[idx] = $('#text-area').val();

                idx = new_idx;
                render();
            }

            // Update the index, and save the text in the text area.
            function set_idxt(new_idx) {

                if (new_idx < 0 || new_idx >= TRAIN_INPUT.length) return;
                // descriptions[idx] = $('#text-area').val();

                idxt = new_idx;
                render();
            }

            // Enable the UI.
            function enable_hit() {
                enabled = true;

                // Enable components
                $('#next-btn').click(function() {
                    t1 = new Date().getTime();
                    time[idx] += t1 - t0;
                    t0 = t1
                    set_idx(idx + 1)
                    console.log(time)
                });
                $('#prev-btn').click(function() {
                    t0 = new Date().getTime();
                    set_idx(idx - 1)
                });

                // Enable components
                $('#next-train-btn').click(function() {
                    set_idxt(idxt + 1)
                });
                $('#prev-train-btn').click(function() {
                    set_idxt(idxt - 1)
                });

                // Set up submit handler.
                simpleamt.setupSubmit();
                var acc = -1;
                $('#submit-train-btn').click(function() {
                    acc = get_accuracy()
                    alert("The test will start once this window is closed, get ready.\n" + acc + "/4")
                    $('#training').css("display", "none");
                    $('#triplet_show').css("display", "block");
                });

                $('#submit-btn').click(function() {
                    var t1 = new Date().getTime();
                    time[idx] = t1 - t0;
                    console.log(answers)
                    var output = _.map(_.zip(ID_INPUT, answers, time, acc), function(x) {
                        return {
                            'triplet_id': x[0],
                            'selection': x[1],
                            'time_spent': x[2],
                            'train_accuracy': x[3]
                        };
                    });
                    simpleamt.setOutput(output);
                });
            }
            main();
        });
    </script>
</body>

</html>
